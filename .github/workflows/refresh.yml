name: run on trigger

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build-and-dump:
    runs-on: ubuntu-latest
    steps:
      # Check out the latest code from the repo
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.24'

      - name: Build
        run: |
          go get
          go build

      - name: Get specific dump asset URLs (by tag)
        id: get_release
        uses: actions/github-script@v6
        with:
          script: |
            const TAG = 'dump-202507281242'; // <-- your exact tag
            try {
              const { data: release } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: TAG,
              });
              if (!release || !release.assets || release.assets.length === 0) {
                core.setFailed(`Release '${TAG}' has no assets`);
              }
              const sqlAssets = release.assets.filter(a => a.name.endsWith('.sql.zst'));
              if (sqlAssets.length === 0) {
                core.setFailed(`No .sql.zst assets found on release '${TAG}'`);
              }
              const sqlUrls = sqlAssets.map(a => a.browser_download_url).join(',');
              core.setOutput('sql_urls', sqlUrls);
              core.setOutput('release_tag', release.tag_name);
              core.setOutput('release_name', release.name);
            } catch (e) {
              core.setFailed(`Failed to get release by tag '${TAG}': ${e.message}`);
            }

      # Download the SQL file from the latest release
      - name: Download SQL file from latest release
        run: |
          echo "Downloading SQL assets..."
          IFS=',' read -r -a sql_urls <<< "${{ steps.get_release.outputs.sql_urls }}"
          for url in "${sql_urls[@]}"; do
            echo "Downloading from $url ..."
            # The -O option saves the file with its remote name
            curl -L -O "${url}"
          done


      - name: Setup MySQL
        run: sudo systemctl start mysql.service
          
      # Import the SQL file into your database
      - name: Import SQL file into database
        run: |
          mysql -h 127.0.0.1 -u root -proot -e "CREATE DATABASE ex;"
          echo "Importing SQL file into the database..."
          for file in *.sql.zst; do
            echo "Importing $file..."
            zstd -dc "$file" | mysql -h 127.0.0.1 -u root -proot ex
          done
          rm -rf *.sql.zst
          
      # Run your program and dump the updated database
      - name: Run the program and dump database
        env: # Or as an environment variable
          COOKIE: ${{ secrets.COOKIE }}
        run: |
          echo "Running the program..."
          # Replace with the command that runs your program
          ./e-hentai-sync -site exhentai --also-expunged --db-host 127.0.0.1 --db-port 3306 --db-user root --db-pass root --db-name ex
          echo "Dumping the database..."
          rm -rf *.sql.zst
          export DATE=$(date +%F)

          for TABLE in $(mysql -h 127.0.0.1 -u root -proot -D ex -e "SHOW TABLES;" | tail -n +2); do
            echo "Dumping table: ${TABLE}"
            export FILENAME="${TABLE}_${DATE}.sql"
            mysqldump -h 127.0.0.1 -u root -proot ex "${TABLE}" | zstd -o "${FILENAME}.zst"
          done

      - name: Generate name
        id: generate_name
        run: echo "::set-output name=name::Dump $(date +'%Y-%m-%d %H:%M')"

      - name: Generate tag name
        id: generate_tag
        run: echo "::set-output name=tag::dump-$(date +'%Y%m%d%H%M')"
        
      # Create a new pre-release with the dump file attached
      - name: Create a pre-release with the dump file and upload artifacts
        id: create_release
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ steps.generate_name.outputs.name }}
          tag: ${{ steps.generate_tag.outputs.tag }}
          prerelease: true
          artifacts: "*.sql.zst"
